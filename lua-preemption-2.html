<!DOCTYPE html>

<link rel="stylesheet" href="style.css">

<html>
  <title>Lua-preemption-2</title>
  <body><p><a href='./blog.html'>Back</a></p>
<p><span class='brightwhite'>Pre-emption 2: Electric Boogaloo</span><br>&nbsp;&nbsp;On <span class='brightwhite'>December 10, 2021</span>, I published <a href='./lua-preemption.html'>a writeup</a> of the pre-emption method I use in <a href='https://github.com/ocawesome101/oc-cynosure'>Cynosure</a>.<br><br>&nbsp;&nbsp;While writing that article, I came across a fairly critical bug that in said article I glossed over because fixing it meant rewriting the entire code processor.&nbsp;&nbsp;The time has come, though, and I had to write a preemption implementation for <a href='https://github.com/ocawesome101/oc-cynosure-2'>Cynosure 2</a>.<br><br>&nbsp;&nbsp;The code for that is <a href='https://github.com/Ocawesome101/oc-cynosure-2/blob/dev/src/scheduler/preempt.lua'>here</a>.&nbsp;&nbsp;You may follow along if you wish.<br><br>&nbsp;&nbsp;So what's different about this new code?</p>
<p><span class='brightwhite'>How It Works</span><br>&nbsp;&nbsp;As with the previous implementation, there is a table of patterns; the primary difference is that there are more of them.&nbsp;&nbsp;They also use Cynosure 2's randomized <span class='code'>sysyield</span> function name to prevent overriding the preemption bits.<br><br>&nbsp;&nbsp;After that table there is the <span class='code'>gsub</span> function, which takes a chunk of code and replaces all the patterns in it.<br><br>&nbsp;&nbsp;Then there is the <span class='code'>wrap</span> function.<br><br>&nbsp;&nbsp;This function takes in a chunk of code.&nbsp;&nbsp;It iterates through that chunk of code and finds either a quote (<span class='brightwhite'>'"</span>) or an open bracket (<span class='brightwhite'>[</span>).<br><br>&nbsp;&nbsp;When it finds a quote, it will flip the internal variable <span class='code'>in_str</span>.&nbsp;&nbsp;There's some extra logic around matching up quote pairs.<br><br>&nbsp;&nbsp;When it finds an open bracket:<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class='brightwhite'>-</span> If that open bracket is immediately followed by another one, this is the beginning of a multiline string.&nbsp;&nbsp;It will find the closest following <span class='code'>]]</span> and attach that to the result string.<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class='brightwhite'>-</span> If the open bracket is followed by some number of <span class='code'>=</span>s and <span class='brightwhite'>then</span> an open bracket, it matches the balance of that and adds the result to the result string: e.g. for <span class='code'>[===[</span> it will find <span class='code'>]===]</span>and treat that as a string.<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class='brightwhite'>-</span> Otherwise, it ignores the bracket and continues.<br><br>&nbsp;&nbsp;This logic is a little simpler than the previous implementation, and doesn't freak out over multiline strings with quotes in them.&nbsp;&nbsp;All-in-all I think it's a much-needed improvement.<br><br>&nbsp;&nbsp;Aside from the above stuff, everything in the previous article still applies to the original Cynosure.</p>
<p><span class='brightwhite'>Conclusion</span><br>&nbsp;&nbsp;I hope you learned something from this article.&nbsp;&nbsp;If you have any questions, message me at <span class='brightwhite'>Ocawesome101#5343</span> on Discord or through <span class='brightwhite'>#oc</span> on <a href='irc.esper.net'>EsperNet</a>.</p>
  </body>
</html>
