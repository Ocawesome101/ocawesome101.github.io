<!DOCTYPE html>

<link rel="stylesheet" href="style.css">

<html>
  <title>486-linux</title>
  <body><p><a href='./blog.html'>Back</a></p>
<p><span class='brightwhite'>Linux on a 486SX</span><br>&nbsp;&nbsp;A year or two ago, I came into posession of a 1993 Compaq Presario 425.&nbsp;&nbsp;It's a Mac-ish all-in-one with a 14" color (S?)VGA screen capable of 800x600 in full 256-color glory.&nbsp;&nbsp;On the inside it features a 25MHz i486SX (the sort without a floating-point unit), paired with 20MB of RAM - a significant upgrade over the stock 4MB.&nbsp;&nbsp;When I received it it had a nearly-dead 1.6GB hard drive<span class='brightwhite'>[1]</span> in it, which I replaced with a far overkill 150GB drive<span class='brightwhite'>[2]</span>.&nbsp;&nbsp;It also has a single 3.5" floppy drive.&nbsp;&nbsp;On the back it has two PS/2 ports for keyboard and mouse input, serial and parallel ports, and two ports for the built-in modem.&nbsp;&nbsp;There is also what appears to be a sound card, along with a single 36-pin connector I don't recognize.<br><br>&nbsp;&nbsp;The hard drive it came with had (as far as I can tell) the stock Windows for Workgroups 3.1 (<span class='brightwhite'>not</span> 3.11) installation, with Wolfenstein 3D and a couple other games.&nbsp;&nbsp;It had clearly been heavily used and contained a large amount of personal data.</p>
<p><span class='brightwhite'>But can it run Linux?</span><br>&nbsp;&nbsp;I've spent the past several months trying on and off to make Linux run on the Presario.&nbsp;&nbsp;The 486SX is the oldest CPU Linux still supports!&nbsp;&nbsp;I was quite hindered by my lack of any floppy disks - fortunately, I managed to get my hands on a few working ones for Christmas this year and made some headway, first getting MS-DOS 6.22 installed on the new hard disk, then messing with the Linux kernel configuration until I got it to work.<br><br>&nbsp;&nbsp;And yesterday I finally got it!&nbsp;&nbsp;Here are the steps for configuring a basic kernel with Linux 5.14.8.<br><br>&nbsp;&nbsp;Begin with <span class='code'>make tinyconfig</span>.&nbsp;&nbsp;Then run <span class='code'>make menuconfig</span>, and change at least the following options:<br>&nbsp;&nbsp;&nbsp;&nbsp;- Under <span class='code'>General setup</span>, turn on *{Configure standard kernel features -> Enable support for printk}, and change the kernel compression mode to <span class='code'>LZO</span> for faster decompression.<br>&nbsp;&nbsp;&nbsp;&nbsp;- Under <span class='code'>Processor type and features</span>, change <span class='code'>Processor family</span> to <span class='code'>486SX</span>.&nbsp;&nbsp;Turn on <span class='code'>Enable the LDT</span> and <span class='code'>Math emulation</span>. Change <span class='code'>Physical address where the kernel is loaded</span> to <span class='code'>0x400000</span> (only necessary for bigger kernels, but good to have).<br>&nbsp;&nbsp;&nbsp;&nbsp;- Under <span class='code'>Bus options (PCI&nbsp;&nbsp;etc.)</span>, enable <span class='code'>ISA support</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;- Turn on <span class='code'>Enable the block layer</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;- Under <span class='code'>Executable file formats</span>, turn on <span class='code'>Kernel support for ELF binaries</span> and <span class='code'>Kernel support for scripts starting with #!</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;- Under <span class='code'>Device drivers</span>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Turn on <span class='code'>Block devices</span> and <span class='code'>Block devices -> Normal floppy disk support</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Under <span class='code'>SCSI device support</span>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Turn on <span class='code'>SCSI disk support</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Turn on <span class='code'>SCSI generic support</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Under <span class='code'>Serial ATA and Parallel ATA drivers (libata)</span>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Turn on <span class='code'>ATA SFF support</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Turn on <span class='code'>Generic platform device PATA support</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Turn on <span class='code'>Legacy ISA PATA support</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Make sure <span class='code'>Input devices -> Keyboards -> AT keyboard</span> is enabled.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Under <span class='code'>Character devices</span>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Turn on <span class='code'>Enable TTY</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Turn on <span class='code'>TTY driver to output user messages via printk</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Make sure <span class='code'>Graphics support -> Console display driver support -> VGA text console</span> is enabled.<br>&nbsp;&nbsp;&nbsp;&nbsp;- Under <span class='code'>File systems</span>, enable <span class='code'>Second extended fs support</span>, <span class='code'>DOS/FAT/EXFAT/NT filesystems -> MSDOS fs support</span>, and <span class='code'>DOS/FAT/EXFAT/NT filesystems -> VFAT (Windows-95) fs support</span>.<br>&nbsp;&nbsp;&nbsp;&nbsp;- Under <span class='code'>File systems -> Pseudo filesystems</span>, enable <span class='code'>/proc file system support</span> and <span class='code'>sysfs file system support</span>.<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;If you've done everything correctly you should have a working kernel.&nbsp;&nbsp;Mine has some other convenience things enabled, but the above is the bare minimum for Linux to boot.<br><br>&nbsp;&nbsp;For the init system and coreutils I chose <a href='https://busybox.net'>BusyBox</a> as it's extremely lightweight.&nbsp;&nbsp;I built it with <a href='https://github.com/richfelker/musl-cross-make'>musl-cross-make</a>.<br><br>&nbsp;&nbsp;For loading the kernel I used <span class='brightwhite'>Syslinux</span> on a FAT partition with the following configuration:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class='brightwhite'>DEFAULT lin<br>&nbsp;&nbsp;&nbsp;&nbsp;LABEL lin<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LINUX /linux<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND rw loglevel=5 root=/dev/sda2</span><br><br>&nbsp;&nbsp;Putting this all together the result is a system image of about 16MB in size (though the image I actually created is 128MB to give some extra space).&nbsp;&nbsp;It's surprisingly responsive for a 30-year-old machine, and only takes around 50 seconds to do a cold boot - not much longer than Windows 95, and at least 30 seconds of that is the BIOS doing a memory test.<br><br>&nbsp;&nbsp;You can download the resulting image <a href='https://oz-craft.pickardayune.com/downloads/486linux.img.xz'>here</a>.&nbsp;&nbsp;You should be able to burn it directly to a hard drive<span class='brightwhite'>[3]</span> and boot it on just about any machine with at least 8MB of RAM - any less than that and Linux fails to decompress, at least in QEMU.&nbsp;&nbsp;Mind that with 8MB you only get about 350KB of memory to work with, but it does boot.&nbsp;&nbsp;I've included almost the full set of BusyBox utilities as well as Lua.&nbsp;&nbsp;Pretty much all of the init setup comes from Krzysztof Krystian Jankowski's <a href='https://bits.p1x.in/floppinux-an-embedded-linux-on-a-single-floppy/'>Floppinux</a> tutorial.&nbsp;&nbsp;The default credentials are <span class='brightwhite'>root</span> / <span class='brightwhite'>root</span>.<br><br>&nbsp;&nbsp;<span class='brightwhite'>Edit 2022-02-01: Slimmed down another MB of memory usage by moving the kernel load offset again; now only requires 8MB</span><br><br>&nbsp;&nbsp;<a href='https://oz-craft.pickardayune.com/vid-compaq-presario-486sx-linux-new.mp4'>Here</a> is a video of the system booting.&nbsp;&nbsp;(<span class='brightwhite'>Edited 2022-01-01: added updated video</span>)<br><br>&nbsp;&nbsp;<a href='https://oz-craft.pickardayune.com/vid-compaq-presario-486sx-linux.mp4'>Here</a> is a (slightly outdated) video of the system booting.&nbsp;&nbsp;Since recording this video I've switched from LZMA to LZO for kernel compression, which made kernel decompression at least 200% faster.</p>
<p><span class='brightwhite'>Footnotes</span><br>&nbsp;&nbsp;<span class='brightwhite'>1.</span>&nbsp;&nbsp;The stock drive was 200MB.<br>&nbsp;&nbsp;<span class='brightwhite'>2.</span>&nbsp;&nbsp;The BIOS can only see 5GB or so of it.&nbsp;&nbsp;I only put in such a large hard drive because that was what I found on Amazon.<br>&nbsp;&nbsp;<span class='brightwhite'>3.</span>&nbsp;&nbsp;After <span class='code'>unxz</span>-ing it, of course.<br></p>
  </body>
</html>
